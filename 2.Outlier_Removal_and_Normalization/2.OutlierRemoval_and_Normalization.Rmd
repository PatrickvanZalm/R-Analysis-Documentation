
#Import libraries and the example DF

```{r}
library(tidyverse)
library(ggpubr)
#We load in a long format as described in chapter 1. 
exampleDF <- read_csv("exampleDF.csv")
```


# Outlier Removal

Hanno (Steen) and I developed this method once to select outliers. The following steps are done:

1. For each protein in the dataset, calculate the median. Thus we create an 'additional sample' which is composed of all median values.
2. Correlate each sample to this created median-sample
3. We calculate the standard deviation of all these correlations
4. We multiply this standard deviation based on how strict we want it. If a sample is x standard deviations away, we consider it an outlier.

This function therefore requires the dataset, the standard deviation strictness and a name since it will also plot (PCA) the data.

### Function

```{r}

OutlierRemover <- function(dataset, Stdv, name){
  
  #Determine correlations between sample and theoretical
  SampleCorrelations <- dataset%>%
    group_by(Protein) %>%
    dplyr::mutate(medianProtein = median(Intensity, na.rm = T)) %>%
    ungroup() %>%
    group_by(Sample) %>%
    dplyr::mutate(SampleCor = stats::cor(Intensity, medianProtein, method = "pearson", use="pairwise.complete.obs")) %>%
    ungroup() %>%
    distinct(Sample, .keep_all = T)
  
  SampleCorrelations <- SampleCorrelations %>%
    dplyr::mutate(Outlier = SampleCor < (1 - Stdv*sd(unique(SampleCorrelations$SampleCor), na.rm = T)))
  
  #Make the DF that we will return (i.e. without outliers)
  returnDataset <- dataset %>%
    dplyr::filter(Sample %in% dplyr::filter(SampleCorrelations, Outlier == F)$Sample) %>%
    dplyr::select(Protein, Sample, Intensity)  
  
  #Purely for visualization: Also attached PCA Plots of the removed samples
  
  #Half minimum value (per protein) imputation
  PCA_DF <- dataset %>% 
    group_by(Protein) %>%
    dplyr::mutate(IntensImputed = replace_na(Intensity, mean(Intensity, na.rm = T)/2)) %>%
    dplyr::select(Protein, Sample, IntensImputed) %>%
    spread(key = "Protein", value = "IntensImputed") %>%
    column_to_rownames("Sample")
  
  #scale and PCA
  PCA_DF_Results <- prcomp(scale(as.matrix(PCA_DF)))
  eigs <- PCA_DF_Results$sdev^2
  variance_percentage <- (eigs / sum(eigs))*100
  pc1var <- round(variance_percentage[1],digits=0)
  pc2var <- round(variance_percentage[2],digits=0)
  
  #Plot
  plot(left_join(SampleCorrelations, rownames_to_column(data.frame(PCA_DF_Results$x)), by = c("Sample" = "rowname")) %>%
         ggplot(aes(x = PC1, y = PC2, colour = Outlier, shape = Outlier)) +
         geom_point(size = 2.5, alpha = 0.6) +
         theme_bw() +
         xlab(paste('PC1',' (',pc1var,'% variance)',sep='')) +
         ylab(paste('PC2',' (',pc2var,'% variance)',sep='')) +
         scale_color_manual(values = c("black", "red")) +
         ggtitle(name))
  
  #Print and Return
  print(paste("The following were removed from:", name, toString(dplyr::filter(SampleCorrelations, Outlier == T)$Sample)))
  return(returnDataset)
}
```

### Usage

```{r}
example_without_outliers <- OutlierRemover(
  exampleDF,
  Stdv = 3, 
  name = "Example Outlier Removal"
)
```


# Normalization

I've made a few normalization methods. Here I describe each of them.

## Normalize - based on pool

In house made normalization method on pool samples. 

1. Determine the median per pooled sample
2. If multiple, determine the median of these medians
3. For each non-pool sample calculate the median
4. Determine what factor needs to be applied to normalize it to the median-pool one
5. Apply this factor

```{r}
#Based on the pool. Requires user to give string_of_pool with ONE systematic naming convention.
normalize_basedonpool <- function(dataset, string_of_pool){
  
  #First calculate per sample the median intensity.
  #Then take the mean of all those medians.
  dataset_references <- 
    dataset %>%
    mutate(Intensity = 2^Intensity)%>%
    dplyr::filter(grepl(string_of_pool, Sample)) %>%
    group_by(Sample) %>%
    summarise(PerSampleMedian = median(Intensity, na.rm = TRUE)) %>%
    ungroup() %>%
    summarise(AverageMedian = mean(PerSampleMedian))
  
  
  #Only select samples, calculate median per sample.
  #Determine per sample normalization factor
  #apply it to intensity column. 
  #clean up.
  dataset_noreferences <- 
    dataset %>%
    mutate(Intensity = 2^Intensity)%>%
    dplyr::filter(!grepl(string_of_pool, Sample)) %>%
    group_by(Sample) %>%
    mutate(PerSampleMedian = median(Intensity, na.rm = TRUE)) %>%
    mutate(NormalizeFactor = dataset_references[[1,1]]/ PerSampleMedian) %>%
    mutate(Intensity = Intensity * NormalizeFactor) %>%
    ungroup() %>%
    mutate(Intensity = log2(Intensity)) %>%
    dplyr::select(Protein, Sample, Intensity)
  
  boxplot_before <- 
    dataset %>%
    dplyr::filter(!grepl(string_of_pool, Sample)) %>%
    ggplot(aes(x = Sample, y = Intensity)) +
    geom_boxplot() +
    theme_bw() +
    theme(axis.ticks.x = element_blank(), axis.text.x = element_blank()) +
    ggtitle("before Normalization") +
    ylab("log2(Intensity)")
  
  boxplot_after <- 
    dataset_noreferences %>%
    ggplot(aes(x = Sample, y = Intensity)) +
    geom_boxplot() +
    theme_bw() +
    theme(axis.ticks.x = element_blank(), axis.text.x = element_blank()) +
    ggtitle("after Normalization") +
    ylab("log2(Intensity)")
  
  plot(ggarrange(boxplot_before, boxplot_after, nrow = 1))
  
  return(dataset_noreferences)
}
```

### Usage

```{r}
example_without_outliers_normalized_pool <- normalize_basedonpool(example_without_outliers, string_of_pool = "Pool")
```


## Normalize - summed intensity

Normalize by calculating median of all summed intensities. Normalize to per sample sum.


```{r}
#User can also remove pool (standard = "")

normalize_summedintensity <- function(dataset, string_of_pool = ""){
  
  dataset_medianSummedIntensity <- dataset %>%
    mutate_all(~replace(., . == 0, NA)) %>%
    mutate(Intensity = 2^Intensity)%>%
    group_by(Sample) %>%
    summarise(PerSampleSum = sum(Intensity, na.rm = TRUE)) %>%
    ungroup() %>%
    summarise(medianOfSummedIntensities = median(PerSampleSum))
  
  if (string_of_pool != ""){
    print("Info on Pools were included. They are used to determine summed Intensity but removed downstream.")
    dataset <- dataset %>%
      dplyr::filter(!grepl(string_of_pool, Sample))
  }
  
  dataset_normalized <-   
    dataset %>%
    mutate(Intensity = 2^Intensity) %>%
    group_by(Sample) %>%
    mutate(PerSampleSum = sum(Intensity, na.rm = TRUE)) %>%
    mutate(NormalizeFactor = dataset_medianSummedIntensity[[1,1]]/ PerSampleSum) %>%
    mutate(Intensity = Intensity * NormalizeFactor) %>%
    ungroup() %>%
    dplyr::select(Protein, Sample, Intensity) %>%
    mutate_all(~replace(., . == 0, NA)) %>%
    mutate(Intensity = log2(Intensity))
  
  boxplot_before <- 
    dataset %>%
    ggplot(aes(x = Sample, y = Intensity)) +
    geom_boxplot() +
    theme_bw() +
    theme(axis.ticks.x = element_blank(), axis.text.x = element_blank()) +
    ggtitle("before Normalization") +
    ylab("log2(Intensity)")
  
  boxplot_after <- 
    dataset_normalized %>%
    ggplot(aes(x = Sample, y = Intensity)) +
    geom_boxplot() +
    theme_bw() +
    theme(axis.ticks.x = element_blank(), axis.text.x = element_blank()) +
    ggtitle("before Normalization") +
    ylab("log2(Intensity)")
  
  plot(ggarrange(boxplot_before, boxplot_after, nrow = 1))
  
  return(dataset_normalized)
}
```

### Usage

```{r}
example_without_outliers_normalized_summedIntens_withPool <- normalize_summedintensity(example_without_outliers, string_of_pool = "Pool")

#OR if you do not have pool dont specify and it wont delete them.

example_without_outliers_normalized_summedIntens_withPool <- normalize_summedintensity(example_without_outliers)
```

## Normalize - Median Intensity

Normalize by calculating median of all summed intensities. Normalize to per sample median.


```{r}
#User can also remove pool (standard = "")

normalize_medianintensity <- function(dataset, string_of_pool = ""){
  
  dataset_medianSummedIntensity <- dataset %>%
    mutate_all(~replace(., . == 0, NA)) %>%
    mutate(Intensity = 2^Intensity)%>%
    group_by(Sample) %>%
    summarise(PerSampleSum = median(Intensity, na.rm = TRUE)) %>%
    ungroup() %>%
    summarise(medianOfSummedIntensities = median(PerSampleSum))
  
  if (string_of_pool != ""){
    print("Info on Pools were included. They are used to determine summed Intensity but removed downstream.")
    dataset <- dataset %>%
      dplyr::filter(!grepl(string_of_pool, Sample))
  }
  
  dataset_normalized <-   
    dataset %>%
    mutate(Intensity = 2^Intensity) %>%
    group_by(Sample) %>%
    mutate(PerSampleSum = median(Intensity, na.rm = TRUE)) %>%
    mutate(NormalizeFactor = dataset_medianSummedIntensity[[1,1]]/ PerSampleSum) %>%
    mutate(Intensity = Intensity * NormalizeFactor) %>%
    ungroup() %>%
    dplyr::select(Protein, Sample, Intensity) %>%
    mutate_all(~replace(., . == 0, NA)) %>%
    mutate(Intensity = log2(Intensity))
  
  boxplot_before <- 
    dataset %>%
    ggplot(aes(x = Sample, y = Intensity)) +
    geom_boxplot() +
    theme_bw() +
    theme(axis.ticks.x = element_blank(), axis.text.x = element_blank()) +
    ggtitle("before Normalization") +
    ylab("log2(Intensity)")
  
  boxplot_after <- 
    dataset_normalized %>%
    ggplot(aes(x = Sample, y = Intensity)) +
    geom_boxplot() +
    theme_bw() +
    theme(axis.ticks.x = element_blank(), axis.text.x = element_blank()) +
    ggtitle("before Normalization") +
    ylab("log2(Intensity)")
  
  plot(ggarrange(boxplot_before, boxplot_after, nrow = 1))
  
  return(dataset_normalized)
}
```

### Usage

```{r}
example_without_outliers_normalized_medianIntens_withPool <- normalize_medianintensity(example_without_outliers, string_of_pool = "Pool")

#OR if you do not have pool dont specify and it wont delete them.

example_without_outliers_normalized_medianIntens_withPool <- normalize_medianintensity(example_without_outliers)
```


## Normalize - VSN

VSN normalization. Assumed log2 transformed data.
check the following DOI
doi: 10.1093/bib/bbw095

```{r}
#VSN normalization. Assumed log2 transformed data.
#check the following DOI
# doi: 10.1093/bib/bbw095

normalize_vsn <- function(dataset, string_of_pool = ""){
  
  if (string_of_pool != ""){
    print("Info on Pools were included. They are used to determine summed Intensity but removed downstream.")
    dataset <- dataset %>%
      dplyr::filter(!grepl(string_of_pool, Sample))
  }
  
  RawMatrix <- dataset %>%
    mutate(Intensity = 2^Intensity) %>%
    spread(Protein, Intensity) %>%
    column_to_rownames("Sample")
  
  normMatrix <- data.frame(suppressMessages(vsn::justvsn(as.matrix(RawMatrix), ))) %>%
    rownames_to_column(var = "Sample") 
  
  dataset_normalized <- tidyr::gather(normMatrix, colnames(normMatrix)[2:ncol(normMatrix)], key = "Protein", value = "Intensity") 
  
  boxplot_before <- 
    dataset %>%
    ggplot(aes(x = Sample, y = Intensity)) +
    geom_boxplot() +
    theme_bw() +
    theme(axis.ticks.x = element_blank(), axis.text.x = element_blank()) +
    ggtitle("before Normalization") +
    ylab("log2(Intensity)")
  
  boxplot_after <- 
    dataset_normalized %>%
    ggplot(aes(x = Sample, y = Intensity)) +
    geom_boxplot() +
    theme_bw() +
    theme(axis.ticks.x = element_blank(), axis.text.x = element_blank()) +
    ggtitle("before Normalization") +
    ylab("log2(Intensity)")
  
  plot(ggarrange(boxplot_before, boxplot_after, nrow = 1))
  
  return(dataset_normalized)
  
}
```


```{r}
example_without_outliers_normalized_vsnIntens_withPool <- normalize_vsn(example_without_outliers, string_of_pool = "Pool")

#OR if you do not have pool dont specify and it wont delete them.

example_without_outliers_normalized_vsnIntens_withPool <- normalize_vsn(example_without_outliers)
```


### Usage

## Normalize - LOESS

LOESS normalization. Assumed log2 transformed data.
check the following DOI
doi: 10.1093/bib/bbw095

```{r}
normalize_loess <- function(dataset, string_of_pool = ""){
  
  if (string_of_pool != ""){
    print("Info on Pools were included. They are used to determine summed Intensity but removed downstream.")
    dataset <- dataset %>%
      dplyr::filter(!grepl(string_of_pool, Sample))
  }
  
  RawMatrix <- dataset %>%
    mutate_all(~replace(., . == 0, NA)) %>%
    spread(Protein, Intensity) %>%
    column_to_rownames("Sample")
  
  normMatrix <- data.frame(limma::normalizeCyclicLoess(as.matrix(RawMatrix), method="fast")) %>%
    rownames_to_column(var = "Sample") 
  
  dataset_normalized <- tidyr::gather(normMatrix, colnames(normMatrix)[2:ncol(normMatrix)], key = "Protein", value = "Intensity") 
  
  boxplot_before <- 
    dataset %>%
    ggplot(aes(x = Sample, y = Intensity)) +
    geom_boxplot() +
    theme_bw() +
    theme(axis.ticks.x = element_blank(), axis.text.x = element_blank()) +
    ggtitle("before Normalization") +
    ylab("log2(Intensity)")
  
  boxplot_after <- 
    dataset_normalized %>%
    ggplot(aes(x = Sample, y = Intensity)) +
    geom_boxplot() +
    theme_bw() +
    theme(axis.ticks.x = element_blank(), axis.text.x = element_blank()) +
    ggtitle("before Normalization") +
    ylab("log2(Intensity)")
  
  plot(ggarrange(boxplot_before, boxplot_after, nrow = 1))
  
  return(dataset_normalized)
}

```

### Usage

```{r}
example_without_outliers_normalized_loessIntens_withPool <- normalize_loess(example_without_outliers, string_of_pool = "Pool")

#OR if you do not have pool dont specify and it wont delete them.

example_without_outliers_normalized_loessIntens_withPool <- normalize_loess(example_without_outliers)
```
